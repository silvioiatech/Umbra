# Umbra F3R1 - OpenRouter Integration & General Chat\n\n🎉 **F3R1 brings full AI conversation capabilities to Umbra!**\n\nThis enhancement adds OpenRouter integration with smart routing and a general chat module with built-in tools.\n\n## 🚀 What's New in F3R1\n\n### ✨ **OpenRouter AI Integration**\n- 🤖 **Full AI Conversation**: Natural language understanding via OpenRouter\n- 🎯 **Role-based Model Routing**: Different models for different tasks\n- ⚡ **Auto-registration**: OpenRouter provider automatically configured\n- 🔄 **Fallback Support**: Graceful degradation when AI unavailable\n\n### 🛠️ **General Chat Module**\n- 🧮 **Built-in Calculator**: Safe mathematical expressions\n- 🕐 **Time Helper**: Current time in Europe/Zurich timezone\n- 📏 **Unit Converter**: Length, weight, temperature conversions\n- 📊 **Table Formatter**: Simple text table creation\n\n### 🎯 **Enhanced Router**\n- 🤝 **AI Fallback**: Unmatched messages route to general_chat\n- 📈 **Better Statistics**: Track AI usage and routing patterns\n- 🔍 **Smart Patterns**: Direct routing for calculations and time\n\n## 🔧 Configuration\n\n### Required Environment Variables\n\n```bash\n# Core Bot (unchanged)\nTELEGRAM_BOT_TOKEN=your_bot_token\nALLOWED_USER_IDS=123456789,987654321\nALLOWED_ADMIN_IDS=123456789\n\n# F3R1: OpenRouter Configuration\nOPENROUTER_API_KEY=your_openrouter_api_key\nOPENROUTER_BASE_URL=https://openrouter.ai/api/v1\nOPENROUTER_DEFAULT_MODEL=anthropic/claude-3.5-sonnet:beta\nOPENROUTER_REQUEST_TIMEOUT_MS=20000\n```\n\n### Optional: Role-based Model Selection\n\n```bash\n# Use different models for different purposes\nOPENROUTER_MODEL_PLANNER=anthropic/claude-3-haiku:beta\nOPENROUTER_MODEL_BUILDER=openai/gpt-4o-mini\nOPENROUTER_MODEL_CONTROLLER=anthropic/claude-3.5-sonnet:beta\nOPENROUTER_MODEL_CHAT=anthropic/claude-3.5-sonnet:beta\n```\n\n## 📋 How to Use\n\n### 🗨️ **Natural Conversation**\nJust chat naturally! The bot now understands and responds intelligently:\n\n```\nUser: \"Tell me about artificial intelligence\"\nUmbra: \"Artificial intelligence (AI) is a field of computer science...\"\n\nUser: \"How does machine learning work?\"\nUmbra: \"Machine learning is a subset of AI that enables computers...\"\n```\n\n### 🧮 **Built-in Calculator**\n```\nUser: \"What's 15% of 847?\"\nUmbra: \"Calculation: 15% of 847 = 127.05\"\n\nUser: \"Calculate sqrt(144)\"\nUmbra: \"Calculation: sqrt(144) = 12\"\n```\n\n### 🕐 **Time Queries**\n```\nUser: \"What time is it?\"\nUmbra: \"Current time: 2025-09-05 14:30:15 CEST\"\n\nUser: \"What's today's date?\"\nUmbra: \"Current time (human): Thursday, September 05, 2025 at 14:30:15 CEST\"\n```\n\n### 📏 **Unit Conversions**\n```\nUser: \"Convert 100 km to miles\"\nUmbra: \"Conversion: 100 km = 62.137 miles\"\n\nUser: \"How many cm in 5 feet?\"\nUmbra: \"Conversion: 5 ft = 152.4 cm\"\n```\n\n### 🛠️ **System Operations** (unchanged)\n```\nUser: \"system status\"\nUmbra: [VPS system information]\n\nUser: \"docker status\"\nUmbra: [Docker container status]\n```\n\n## 🎯 Routing Logic\n\nF3R1 uses intelligent routing with this priority:\n\n1. **🎯 Deterministic Patterns**: Exact commands (`/status`, `system status`)\n2. **🧮 Built-in Tools**: Math, time, conversions (`calculate`, `what time`)\n3. **🤖 AI Fallback**: Everything else goes to general_chat with OpenRouter\n4. **📝 Basic Fallback**: If AI unavailable, basic pattern responses\n\n## 🔍 Available Commands\n\n### **System Commands**\n- `/start` - Welcome message and introduction\n- `/help` - Show available commands and patterns\n- `/status` - Comprehensive system status\n\n### **Built-in Tools** (new in F3R1)\n- `calculate [expression]` - Mathematical calculations\n- `what time` / `current time` - Get current time\n- `convert [value] [unit] to [unit]` - Unit conversions\n\n### **Natural Language** (new in F3R1)\n- Ask any question naturally\n- Request explanations, analysis, advice\n- General conversation and assistance\n\n### **System Management**\n- `system status` - VPS resource information\n- `docker status` - Container status\n- `resource usage` - Detailed resource breakdown\n- `execute [command]` - Shell command execution (admin only)\n\n## 🔧 Development\n\n### Running Tests\n\n```bash\n# Install test dependencies\npip install pytest pytest-asyncio\n\n# Run F3R1 tests\npytest tests/test_openrouter.py -v\npytest tests/test_general_chat.py -v\npytest tests/test_router_f3r1.py -v\npytest tests/test_ai_agent_f3r1.py -v\npytest tests/test_f3r1_integration.py -v\n\n# Run all tests\npytest tests/ -v\n```\n\n### F3R1 Architecture\n\n```\n📱 Telegram Bot\n    ↓\n🎯 Router (F3R1 Enhanced)\n    ├─ Deterministic Patterns → 🛠️ Modules\n    ├─ Built-in Tools → 🧮 General Chat\n    └─ Everything Else → 🤖 AI Agent\n                            ↓\n                        🌐 OpenRouter API\n                            ↓\n                        🧠 Claude/GPT Models\n```\n\n### Key Components\n\n- **🤖 UmbraAIAgent**: Provider-agnostic with auto-registration\n- **🌐 OpenRouterProvider**: Role-based model routing\n- **🧮 GeneralChatMCP**: Built-in tools + AI integration\n- **🎯 UmbraRouter**: Enhanced with AI fallback\n\n## 📊 Status & Monitoring\n\nUse `/status` to see comprehensive F3R1 information:\n\n```\n🤖 Umbra Bot Status\n\nCore: 🟢 Running\nUptime: 2h 15m\nMode: F3R1 (Enhanced AI + Module Registry)\n\n🧠 AI Agent: F3R1_enhanced\nProviders: 1 available\n\n🛠️ Modules: 6/6 available\nAvailable: general_chat_mcp, concierge_mcp, finance_mcp, ...\n\n📊 Router: 87% match rate\nPatterns: 25 configured\nRequests: 142 processed\n```\n\n## 🚀 Deployment\n\n### Railway Deployment\n\n1. **Set Environment Variables** in Railway:\n   ```bash\n   OPENROUTER_API_KEY=your_key_here\n   OPENROUTER_DEFAULT_MODEL=anthropic/claude-3.5-sonnet:beta\n   # ... other variables\n   ```\n\n2. **Deploy**: Railway will automatically detect changes and redeploy\n\n3. **Verify**: Use `/status` in Telegram to confirm F3R1 is active\n\n### Local Development\n\n```bash\n# Clone and setup\ngit clone [your-repo]\ncd UMBRA\ncp .env.example .env\n# Edit .env with your keys\n\n# Install dependencies\npip install -r requirements.txt\n\n# Run\npython main.py\n```\n\n## 🐛 Troubleshooting\n\n### OpenRouter Issues\n\n**Problem**: \"No AI provider available\"\n```bash\n# Check your API key\necho $OPENROUTER_API_KEY\n\n# Verify model name\necho $OPENROUTER_DEFAULT_MODEL\n```\n\n**Problem**: Rate limits or timeouts\n```bash\n# Increase timeout\nOPENROUTER_REQUEST_TIMEOUT_MS=30000\n\n# Use cheaper model for chat\nOPENROUTER_MODEL_CHAT=anthropic/claude-3-haiku:beta\n```\n\n### General Chat Issues\n\n**Problem**: Calculator not working\n- Check for safe expressions only\n- No `import`, `exec`, or `__` allowed\n\n**Problem**: Time zone incorrect\n```bash\n# Set correct timezone\nLOCALE_TZ=Europe/Zurich\n```\n\n### Router Issues\n\n**Problem**: Messages not routing to AI\n- Check `/status` for general_chat_mcp availability\n- Verify OpenRouter configuration\n- Check logs for routing statistics\n\n## 📈 What's Next\n\nF3R1 sets the foundation for upcoming features:\n\n- **F4R2**: R2 Object Storage integration\n- **BOT2**: Enhanced `/status` command\n- **C1-C3**: Concierge module enhancements\n- **BUS1**: Business module with instance management\n- **FNC1**: Swiss Accountant finance module\n\n---\n\n## 🔗 Links\n\n- **OpenRouter**: https://openrouter.ai/ (Get API keys)\n- **Railway**: https://railway.app/ (Deployment platform)\n- **Telegram BotFather**: https://t.me/BotFather (Create bot)\n\n**Enjoy your enhanced AI-powered Umbra bot! 🎉**\n"