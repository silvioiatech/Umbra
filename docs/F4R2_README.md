# Umbra F4R2 - Cloudflare R2 Object Storage\n\nüöÄ **F4R2 brings enterprise-grade object storage to Umbra with R2-first architecture!**\n\nThis feature replaces SQLite with Cloudflare R2 for scalable, distributed storage using JSONL/Parquet manifests and built-in search capabilities.\n\n## üåü What's New in F4R2\n\n### ‚ú® **R2-First Architecture**\n- ü™£ **Cloudflare R2 Integration**: S3-compatible object storage with global edge\n- üìÑ **JSONL Manifests**: Append-only data streams with ETag concurrency\n- üìä **Parquet Support**: Columnar storage for analytics (with CSV fallback)\n- üîç **Built-in Search**: Simple inverted index for text and merchant search\n- üîê **Presigned URLs**: Secure, time-limited access to stored objects\n\n### üõ†Ô∏è **Core Components**\n- **R2Client**: Low-level S3-compatible API client\n- **ObjectStorage**: High-level object operations with utilities\n- **ManifestManager**: JSONL/Parquet manifest files with optimistic locking\n- **SearchIndex**: Simple text search across stored documents\n\n### üéØ **Key Features**\n- ‚ö° **ETag Concurrency**: Optimistic locking for manifest updates\n- üîÑ **Automatic Retries**: Exponential backoff for network resilience\n- üìà **Partitioning**: Monthly Parquet partitions for time-series data\n- üßÆ **SHA256 Verification**: Data integrity checks on upload/download\n- üì± **Multi-format Support**: JSONL for real-time, Parquet for analytics\n\n## üîß Configuration\n\n### Required Environment Variables\n\n```bash\n# Core Bot (unchanged)\nTELEGRAM_BOT_TOKEN=your_bot_token\nALLOWED_USER_IDS=123456789,987654321\nALLOWED_ADMIN_IDS=123456789\n\n# F4R2: Cloudflare R2 Configuration\nR2_ACCOUNT_ID=your_cloudflare_account_id\nR2_ACCESS_KEY_ID=your_r2_access_key_id\nR2_SECRET_ACCESS_KEY=your_r2_secret_access_key\nR2_BUCKET=your_r2_bucket_name\nR2_ENDPOINT=https://your_account_id.r2.cloudflarestorage.com\n```\n\n### Getting R2 Credentials\n\n1. **Log in to Cloudflare Dashboard**\n2. **Go to R2 Object Storage**\n3. **Create a Bucket** (if you don't have one)\n4. **Create API Token**:\n   - Go to \"Manage R2 API tokens\"\n   - Create token with \"Object Read & Write\" permissions\n   - Note down Access Key ID and Secret Access Key\n5. **Find Account ID**: Available in the right sidebar\n\n## üì¶ Object Layout\n\nF4R2 organizes data in R2 using a structured hierarchy:\n\n```\nr2://{BUCKET}/\n  manifests/\n    swiss_accountant/\n      expenses-{user_id}.jsonl          # Real-time expense entries\n      transactions-{user_id}-2025-01.parquet  # Monthly transaction analytics\n    creator/\n      templates.jsonl                   # Global templates\n      brand_voice.json                  # Configuration data\n    concierge/\n      instances.json                    # Instance registry\n      search_index-{user_id}.json       # Search indexes\n  documents/\n    {sha256}.{ext}                      # Content-addressed documents\n  exports/\n    {module}/{timestamp}-{name}.{zip|csv|json}  # Generated exports\n```\n\n## üöÄ Usage Examples\n\n### Basic Object Storage\n\n```python\nfrom umbra.storage import ObjectStorage\n\n# Initialize storage\nstorage = ObjectStorage()\n\n# Store a document\nresult = storage.put_object(\n    key=\"documents/report.pdf\",\n    data=pdf_bytes,\n    content_type=\"application/pdf\",\n    metadata={\"author\": \"John Doe\", \"version\": \"1.0\"}\n)\nprint(f\"Stored with ETag: {result['etag']}\")\n\n# Retrieve a document\ndocument = storage.get_object(\"documents/report.pdf\")\nprint(f\"Retrieved {len(document['data'])} bytes\")\n\n# Generate presigned URL (1 hour expiry)\nurl = storage.generate_presigned_url(\n    key=\"documents/report.pdf\",\n    expiration=3600,\n    method=\"download\"\n)\nprint(f\"Download URL: {url}\")\n\n# Store JSON configuration\nconfig_data = {\"theme\": \"dark\", \"language\": \"en\"}\nstorage.put_json(\"config/settings.json\", config_data)\n\n# Retrieve JSON\nconfig = storage.get_json(\"config/settings.json\")\nprint(f\"Settings: {config['json_data']}\")\n```\n\n### JSONL Manifests (Real-time Data)\n\n```python\nfrom umbra.storage import ObjectStorage, ManifestManager\n\n# Initialize\nstorage = ObjectStorage()\nmanifests = ManifestManager(storage)\n\n# Append expense entry\nexpense = {\n    \"amount\": 25.50,\n    \"merchant\": \"Coffee Shop\",\n    \"category\": \"Food & Drink\",\n    \"date\": \"2025-01-15\"\n}\n\nresult = manifests.append_jsonl(\n    module=\"swiss_accountant\",\n    name=\"expenses\",\n    entry=expense,\n    user_id=123\n)\nprint(f\"Added entry {result['entry_id']}\")\n\n# Read recent expenses\nfor entry in manifests.read_jsonl(\n    module=\"swiss_accountant\",\n    name=\"expenses\",\n    user_id=123,\n    limit=10\n):\n    print(f\"{entry.timestamp}: {entry.data['merchant']} - ${entry.data['amount']}\")\n\n# Read expenses since yesterday\nfrom datetime import datetime, timedelta, timezone\nyesterday = (datetime.now(timezone.utc) - timedelta(days=1)).isoformat()\n\nrecent_expenses = list(manifests.read_jsonl(\n    module=\"swiss_accountant\",\n    name=\"expenses\",\n    user_id=123,\n    since_timestamp=yesterday\n))\nprint(f\"Found {len(recent_expenses)} recent expenses\")\n```\n\n### Parquet Manifests (Analytics)\n\n```python\n# Monthly transaction analytics\ntransactions = [\n    {\n        \"date\": \"2025-01-05\",\n        \"amount\": 1500.00,\n        \"merchant\": \"Tech Conference\",\n        \"category\": \"Education\",\n        \"payment_method\": \"Credit Card\"\n    },\n    {\n        \"date\": \"2025-01-10\",\n        \"amount\": 75.25,\n        \"merchant\": \"Gas Station\",\n        \"category\": \"Travel\",\n        \"payment_method\": \"Debit Card\"\n    }\n]\n\n# Store as Parquet (with automatic partitioning)\nresult = manifests.write_parquet(\n    module=\"swiss_accountant\",\n    name=\"transactions\",\n    data=transactions,\n    partition=\"2025-01\",  # Optional: auto-generated if not provided\n    user_id=123,\n    schema={  # Optional: for type safety\n        \"date\": \"string\",\n        \"amount\": \"float64\",\n        \"merchant\": \"string\",\n        \"category\": \"string\",\n        \"payment_method\": \"string\"\n    }\n)\nprint(f\"Stored {result['records']} transactions in {result['format']} format\")\n\n# Read Parquet data\ntransaction_data = manifests.read_parquet(\n    module=\"swiss_accountant\",\n    name=\"transactions\",\n    partition=\"2025-01\",\n    user_id=123,\n    columns=[\"date\", \"amount\", \"merchant\"]  # Optional: column selection\n)\n\nfor transaction in transaction_data:\n    print(f\"{transaction['date']}: {transaction['merchant']} - ${transaction['amount']}\")\n\n# List available partitions\npartitions = manifests.list_partitions(\n    module=\"swiss_accountant\",\n    name=\"transactions\",\n    user_id=123\n)\n\nfor partition in partitions:\n    print(f\"Partition {partition['partition']}: {partition['size']} bytes ({partition['format']})\")\n```\n\n### Document Storage with SHA256\n\n```python\n# Store document with content-addressed naming\nwith open(\"receipt.pdf\", \"rb\") as f:\n    pdf_data = f.read()\n\ndoc_result = storage.store_document(\n    data=pdf_data,\n    filename=\"receipt.pdf\",\n    content_type=\"application/pdf\"\n)\n\nif doc_result[\"already_exists\"]:\n    print(f\"Document already exists: {doc_result['key']}\")\nelse:\n    print(f\"New document stored: {doc_result['key']}\")\n    print(f\"SHA256: {doc_result['sha256']}\")\n\n# Generate secure download URL\ndownload_url = storage.generate_presigned_url(\n    key=doc_result[\"key\"],\n    expiration=1800,  # 30 minutes\n    method=\"download\"\n)\nprint(f\"Secure download: {download_url}\")\n```\n\n### Search Index\n\n```python\nfrom umbra.storage import SearchIndex\n\n# Initialize search\nsearch = SearchIndex(storage)\n\n# Index documents\nsearch.add_document(\n    module=\"swiss_accountant\",\n    document_id=\"receipt_001\",\n    text_content=\"Restaurant receipt for business dinner with clients\",\n    metadata={\"amount\": 125.50, \"date\": \"2025-01-15\"},\n    merchant=\"Fine Dining Restaurant\",\n    user_id=123\n)\n\nsearch.add_document(\n    module=\"swiss_accountant\",\n    document_id=\"receipt_002\",\n    text_content=\"Coffee shop receipt for morning meeting\",\n    metadata={\"amount\": 8.75, \"date\": \"2025-01-16\"},\n    merchant=\"Downtown Coffee\",\n    user_id=123\n)\n\n# Search by keywords\nbusiness_results = search.search_keywords(\n    module=\"swiss_accountant\",\n    keywords=[\"business\", \"dinner\"],\n    user_id=123,\n    operator=\"AND\"\n)\n\nfor result in business_results:\n    print(f\"Found: {result['document_id']} - {result['merchant']}\")\n\n# Search by merchant\ncoffee_results = search.search_merchants(\n    module=\"swiss_accountant\",\n    merchant_query=\"coffee\",\n    user_id=123\n)\n\nfor result in coffee_results:\n    print(f\"Coffee expense: {result['document_id']} - ${result['metadata']['amount']}\")\n\n# Get search statistics\nstats = search.get_index_stats(\"swiss_accountant\", 123)\nprint(f\"Indexed {stats['stats']['total_documents']} documents with {stats['stats']['total_terms']} terms\")\n```\n\n### Error Handling\n\n```python\nfrom umbra.storage import (\n    ObjectStorage, ManifestManager, SearchIndex,\n    ObjectStorageError, ManifestError, SearchIndexError,\n    R2ClientError, ObjectNotFoundError\n)\n\nstorage = ObjectStorage()\n\ntry:\n    # Attempt operation\n    result = storage.get_object(\"nonexistent/file.txt\")\nexcept ObjectNotFoundError:\n    print(\"File not found - this is expected\")\nexcept ObjectStorageError as e:\n    print(f\"Storage error: {e}\")\nexcept R2ClientError as e:\n    print(f\"R2 API error: {e}\")\n\n# Check availability before operations\nif not storage.is_available():\n    print(\"R2 storage not configured or unavailable\")\n    # Handle gracefully - maybe use local storage fallback\nelse:\n    print(\"R2 storage ready for operations\")\n\n# Manifest concurrency handling\nmanifests = ManifestManager(storage)\n\ntry:\n    result = manifests.append_jsonl(\n        module=\"test\",\n        name=\"data\",\n        entry={\"test\": \"data\"},\n        max_retries=3  # Will retry on ETag conflicts\n    )\n    print(f\"Append succeeded on attempt {result['attempt']}\")\nexcept ManifestConcurrencyError:\n    print(\"Too many concurrent writes - try again later\")\nexcept ManifestError as e:\n    print(f\"Manifest error: {e}\")\n```\n\n## üìä Monitoring & Statistics\n\n### Storage Statistics\n\n```python\n# Get overall storage usage\nstats = storage.get_storage_stats()\n\nif stats[\"available\"]:\n    print(f\"Bucket: {stats['bucket']}\")\n    print(f\"Total objects: {stats['objects']['total']}\")\n    print(f\"Total size: {stats['sizes']['total_bytes']} bytes\")\n    print(f\"Manifests: {stats['objects']['manifests']}\")\n    print(f\"Documents: {stats['objects']['documents']}\")\n    print(f\"Exports: {stats['objects']['exports']}\")\nelse:\n    print(f\"Storage unavailable: {stats.get('error', 'Unknown error')}\")\n\n# Get manifest statistics\nmanifest_stats = manifests.get_manifest_stats()\n\nprint(f\"Total manifests: {manifest_stats['total_manifests']}\")\nprint(f\"By format: {manifest_stats['by_format']}\")\nprint(f\"By module: {manifest_stats['by_module']}\")\nprint(f\"Parquet available: {manifest_stats['parquet_available']}\")\n\n# Get search index statistics\nindex_stats = search.get_index_stats(\"swiss_accountant\", 123)\n\nif index_stats[\"available\"]:\n    stats = index_stats[\"stats\"]\n    print(f\"Indexed documents: {stats['total_documents']}\")\n    print(f\"Unique terms: {stats['total_terms']}\")\n    print(f\"Merchants: {stats['total_merchants']}\")\n    print(f\"Sample terms: {index_stats['sample_terms']}\")\n```\n\n### Health Checks\n\n```python\n# Basic availability checks\nprint(f\"R2 Client: {'‚úÖ' if storage.r2_client.is_available() else '‚ùå'}\")\nprint(f\"Object Storage: {'‚úÖ' if storage.is_available() else '‚ùå'}\")\nprint(f\"Manifest Manager: {'‚úÖ' if manifests.is_available() else '‚ùå'}\")\nprint(f\"Search Index: {'‚úÖ' if search.is_available() else '‚ùå'}\")\n\n# Detailed client information\nclient_info = storage.r2_client.get_client_info()\nprint(f\"R2 Configuration: {client_info}\")\n```\n\n## üß™ Development & Testing\n\n### Running Tests\n\n```bash\n# Install test dependencies\npip install pytest pytest-asyncio\n\n# Run F4R2 tests\npytest tests/test_r2_client.py -v\npytest tests/test_object_storage.py -v\npytest tests/test_manifest_manager.py -v\npytest tests/test_search_index.py -v\npytest tests/test_f4r2_integration.py -v\n\n# Run all storage tests\npytest tests/test_*storage* tests/test_*r2* tests/test_*manifest* tests/test_*search* -v\n\n# With coverage\npytest --cov=umbra.storage tests/ -v\n```\n\n### Local Development\n\n```bash\n# Setup development environment\ngit clone [your-repo]\ncd UMBRA\ncp .env.example .env\n# Edit .env with your R2 credentials\n\n# Install dependencies (includes PyArrow for Parquet)\npip install -r requirements.txt\n\n# Test R2 connection\npython -c \"\nfrom umbra.storage import ObjectStorage\nstorage = ObjectStorage()\nprint('R2 Available:', storage.is_available())\nif storage.is_available():\n    stats = storage.get_storage_stats()\n    print('Bucket:', stats['bucket'])\n\"\n```\n\n### Example Test Script\n\n```python\n#!/usr/bin/env python3\n\"\"\"F4R2 Test Script - Verify R2 storage functionality\"\"\"\n\nimport os\nfrom umbra.storage import ObjectStorage, ManifestManager, SearchIndex\n\ndef test_f4r2():\n    # Initialize components\n    storage = ObjectStorage()\n    manifests = ManifestManager(storage)\n    search = SearchIndex(storage)\n    \n    print(\"üîç F4R2 Health Check\")\n    print(f\"R2 Available: {'‚úÖ' if storage.is_available() else '‚ùå'}\")\n    \n    if not storage.is_available():\n        print(\"‚ùå R2 not configured. Set R2_* environment variables.\")\n        return\n    \n    # Test basic operations\n    print(\"\\nüìÑ Testing Object Storage...\")\n    test_data = b\"Hello F4R2!\"\n    \n    # Store object\n    result = storage.put_object(\"test/hello.txt\", test_data)\n    print(f\"‚úÖ Stored object with ETag: {result['etag'][:8]}...\")\n    \n    # Retrieve object\n    retrieved = storage.get_object(\"test/hello.txt\")\n    print(f\"‚úÖ Retrieved {len(retrieved['data'])} bytes\")\n    \n    # Test JSONL manifest\n    print(\"\\nüìù Testing JSONL Manifests...\")\n    entry = {\"message\": \"Hello from F4R2!\", \"timestamp\": \"2025-01-01T00:00:00Z\"}\n    \n    manifest_result = manifests.append_jsonl(\n        module=\"test\",\n        name=\"messages\",\n        entry=entry\n    )\n    print(f\"‚úÖ Added manifest entry: {manifest_result['entry_id']}\")\n    \n    # Test search index\n    print(\"\\nüîç Testing Search Index...\")\n    search_result = search.add_document(\n        module=\"test\",\n        document_id=\"test_doc_1\",\n        text_content=\"This is a test document for F4R2 search functionality\",\n        metadata={\"type\": \"test\"}\n    )\n    print(f\"‚úÖ Indexed document with {search_result['words_indexed']} words\")\n    \n    # Search test\n    results = search.search_keywords(\n        module=\"test\",\n        keywords=[\"test\", \"document\"]\n    )\n    print(f\"‚úÖ Found {len(results)} search results\")\n    \n    # Get statistics\n    print(\"\\nüìä Storage Statistics\")\n    stats = storage.get_storage_stats()\n    print(f\"Total objects: {stats['objects']['total']}\")\n    print(f\"Total size: {stats['sizes']['total_bytes']} bytes\")\n    \n    print(\"\\nüéâ F4R2 test completed successfully!\")\n\nif __name__ == \"__main__\":\n    test_f4r2()\n```\n\n## üöÄ Deployment\n\n### Railway Deployment\n\n1. **Set Environment Variables** in Railway:\n   ```bash\n   R2_ACCOUNT_ID=your_cloudflare_account_id\n   R2_ACCESS_KEY_ID=your_r2_access_key_id\n   R2_SECRET_ACCESS_KEY=your_r2_secret_access_key\n   R2_BUCKET=your_r2_bucket_name\n   # R2_ENDPOINT will be auto-generated from account ID\n   ```\n\n2. **Deploy**: Railway will automatically detect changes and redeploy\n\n3. **Verify**: Use `/status` in Telegram to confirm F4R2 is active\n\n### Production Considerations\n\n- **Bucket Lifecycle**: Configure R2 lifecycle rules for automatic cleanup of old exports\n- **Access Control**: Use least-privilege R2 API tokens\n- **Monitoring**: Set up Cloudflare Analytics for R2 usage\n- **Backup**: Consider cross-region replication for critical data\n- **Cost Optimization**: Monitor R2 usage and optimize data organization\n\n## üêõ Troubleshooting\n\n### R2 Connection Issues\n\n**Problem**: \"R2 client not available\"\n```bash\n# Check your credentials\necho $R2_ACCOUNT_ID\necho $R2_ACCESS_KEY_ID\necho $R2_BUCKET\n\n# Verify bucket exists and is accessible\n# Test with AWS CLI (S3 compatible)\naws s3 ls s3://your-bucket --endpoint-url=https://your-account.r2.cloudflarestorage.com\n```\n\n**Problem**: \"Authentication failed\"\n- Verify API token has correct permissions\n- Check Account ID matches the token\n- Ensure bucket name is correct\n\n### Performance Issues\n\n**Problem**: Slow uploads/downloads\n```bash\n# Increase timeout\nR2_REQUEST_TIMEOUT_MS=30000\n\n# Check R2 analytics in Cloudflare dashboard\n# Consider geographical proximity to R2 regions\n```\n\n**Problem**: ETag conflicts in manifests\n- This is normal for concurrent writes\n- Increase `max_retries` parameter\n- Consider batching writes if possible\n\n### Parquet Issues\n\n**Problem**: \"PyArrow not available\"\n```bash\n# Install PyArrow for Parquet support\npip install pyarrow==15.0.2\n\n# F4R2 falls back to CSV automatically\n# Check logs for \"falling back to CSV\" messages\n```\n\n**Problem**: Large Parquet files\n- Use monthly partitioning\n- Consider data compression settings\n- Monitor R2 storage costs\n\n### Search Index Issues\n\n**Problem**: Search not finding documents\n- Check document was indexed: `search.get_index_stats()`\n- Try broader keywords\n- Verify text normalization (accents, case)\n\n**Problem**: Search index too large\n- Consider per-user indexes\n- Implement index cleanup for old documents\n- Use pagination for search results\n\n## üìà What's Next\n\nF4R2 enables future Umbra features:\n\n- **Swiss Accountant (FNC1)**: Receipt storage and expense tracking\n- **Creator Module (CRT3)**: Media file storage and templates\n- **Business Module (BUS1)**: Document management per instance\n- **Analytics**: Parquet-based reporting and insights\n- **Search**: Enhanced full-text search across all modules\n\n---\n\n## üîó Links\n\n- **Cloudflare R2**: https://developers.cloudflare.com/r2/ (Documentation)\n- **Railway**: https://railway.app/ (Deployment platform)\n- **PyArrow**: https://arrow.apache.org/docs/python/ (Parquet support)\n- **Boto3**: https://boto3.amazonaws.com/v1/documentation/api/latest/index.html (S3 API)\n\n**Enjoy enterprise-scale object storage with F4R2! üéâ**\n"